<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>GENESIS NG – Outil d'analyse de la preuve numérique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://www.interieur.gouv.fr/themes/custom/dsfr/src/images/logo/favicon.png">

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/utility/utilities.min.css">

  <style>
    body { margin: 0; background: #fff; }
    .fr-header, .fr-header__brand { filter: none !important; }

    .genesis-main { padding: 2rem 0; }

    .genesis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .btn-align-right {
  display: inline-flex;
  margin-left: auto;
}

/* Barre actions alignée EXACTEMENT sur les colonnes Texte/Résultats */
.genesis-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;              /* même gap que .genesis-grid */
  align-items: center;
  margin-bottom: 2rem;    /* équivalent à fr-mb-2w */
}

.genesis-actions-right {
  display: flex;
  justify-content: flex-end; /* colle le bouton à droite */
}

/* Alignement vertical flèche + texte dans les boutons retour */
.fr-btn {
  display: inline-flex;
  align-items: center;
}

    textarea {
      min-height: 360px;
      font-family: monospace;
    }

    .results {
      min-height: 360px;
      padding: 1rem;
      border: 1px solid var(--border-default-grey);
      background: var(--background-alt-grey);
      overflow-y: auto;
    }

    .genesis-credit {
      position: fixed;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: #666;
      opacity: 0.2;
      pointer-events: none;
      user-select: none;
    }

    /* Petite aide: aligne le SVG comme dans ton exemple */
    .btn-svg {
      vertical-align: middle;
    }

    /* Alignement vertical icône + texte dans les boutons Retour */
.fr-btn.fr-btn--icon-left {
  display: inline-flex;      /* sécurité */
  align-items: center;       /* centre verticalement */
  gap: 0.5rem;               /* espace icône/texte (ajuste si tu veux) */
}

.fr-btn.fr-btn--icon-left > span[aria-hidden="true"] {
  display: inline-flex;      /* évite le “baseline” */
  align-items: center;
}

.fr-btn.fr-btn--icon-left svg {
  display: block;            /* supprime les décalages baseline */
}

/* Fixe une taille visuelle, sans zoom */
.fr-card__img img {
  width: 64px;
  height: 64px;
  object-fit: contain;
  display: block;
}

/* ---- Cartes accueil : image en haut, SVG non zoomé ---- */
.fr-card__img {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1.25rem;          /* respirations DSFR-like */
}

/* Taille du SVG (tu peux changer la valeur) */
.fr-card__img img {
  width: 210px;               /* <- c’est ici que tu gères la taille */
  height: 120px;
  object-fit: contain;
  display: block;
}

/* Titre + badge alignés proprement */
.card-title-row {
  display: flex;
  align-items: center;   /* alignement vertical parfait */
  gap: 0.5rem;           /* espace badge / texte */
}

/* Badge plus discret, sans impacter le layout */
.fr-badge--sm {
  font-size: 0.65rem;
  line-height: 1;
  padding: 0.25rem 0.5rem;
}

/* Badge aligné à gauche (au cas où un parent centre) */
.genesis-badge {
  display: inline-flex;
  align-self: flex-start;
}

/* Badge “fantôme” : garde la place mais ne s’affiche pas */
.genesis-badge--ghost {
  visibility: hidden;     /* invisible */
  pointer-events: none;   /* ne capte pas les clics */
}

  </style>
</head>

<body>

<!-- HEADER OFFICIEL -->
<header role="banner" class="fr-header">
  <div class="fr-header__body">
    <div class="fr-container">
      <div class="fr-header__body-row">
        <div class="fr-header__brand fr-enlarge-link">
          <div class="fr-header__brand-top">
            <div class="fr-header__logo">
              <p class="fr-logo">Ministère<br>de l’Intérieur</p>
            </div>
          </div>
          <div class="fr-header__service">
            <p class="fr-header__service-title">GENESIS NG</p>
            <p class="fr-header__service-tagline">
              Outil d’analyse de la preuve numérique
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- ACCUEIL -->
<div id="view-home">
  <main class="genesis-main">
    <div class="fr-container">
      <div class="fr-grid-row fr-grid-row--center fr-mt-3w">
        <div class="fr-col-12 fr-col-md-10 fr-col-lg-8">
          <h1 class="fr-h3 fr-mb-2w">Choisir un module</h1>
          <p class="fr-text--lg fr-mb-4w">
            Sélectionnez le type de contenu à analyser.
          </p>

          <div class="fr-grid-row fr-grid-row--gutters">

  <!-- CARTE 1 : Entête de mail (VERTICALE) -->
<div class="fr-col-12 fr-col-md-6">
  <div class="fr-card fr-enlarge-link">
    
    <!-- Image / SVG de la carte -->
    <div class="fr-card__img">
      <img src="assets/svg/mail-send.svg" alt="" aria-hidden="true">
    </div>

    <div class="fr-card__body">
      <div class="fr-card__content">
        <div class="fr-card__content">

  <!-- Slot badge (invisible) pour aligner avec la carte 2 -->
  <p class="fr-badge fr-badge--new fr-badge--icon-lightning-line fr-badge--sm fr-mb-2v genesis-badge genesis-badge--ghost"
     aria-hidden="true">
    Nouveau
  </p>

        <h3 class="fr-card__title">
          <a class="fr-card__link" href="#" id="btn-go-analyse">
            Entête de mail
          </a>
        </h3>

        <p class="fr-card__desc">
          Extraction d’IP, adresses e-mails et informations sur l’appareil expéditeur.
        </p>

        <div class="fr-card__end">
          <p class="fr-card__detail">
            Ouvrir le module
          </p>
        </div>
      </div>
    </div>

  </div>
</div>

 <!-- CARTE 2 : Résultat réquisition (désactivée) -->
<div class="fr-col-12 fr-col-md-6">
  <div class="fr-card fr-enlarge-link" aria-disabled="true">

    <!-- Image / SVG de la carte (AU-DESSUS) -->
    <div class="fr-card__img">
      <img src="assets/svg/data-visualization.svg" alt="" aria-hidden="true">
    </div>

    <div class="fr-card__body">
      <div class="fr-card__content">

  <!-- Badge AU-DESSUS -->
  <p class="fr-badge fr-badge--new fr-badge--icon-lightning-line fr-badge--sm fr-mb-2v genesis-badge">
  Nouveau
</p>

  <!-- Titre pleine largeur -->
  <h3 class="fr-card__title">
    <a class="fr-card__link" href="#" id="btn-go-req" aria-disabled="true" tabindex="-1">
      Résultat de réquisition
    </a>
  </h3>

  <p class="fr-card__desc">
    Extraction depuis un résultat de réquisition
    (mail, IP, téléphone, adresse…)
  </p>

  <div class="fr-card__end">
    <p class="fr-card__detail">
      Formats : ".pdf, .odt, .calc, .csv, .txt…"
    </p>
    <p class="fr-card__detail">
      Ouvrir le module
    </p>
  </div>

</div>

          </div> <!-- .fr-grid-row fr-grid-row--gutters -->
        </div>   <!-- .fr-col-12 ... -->
      </div>     <!-- .fr-grid-row fr-grid-row--center ... -->
    </div>       <!-- .fr-container -->
  </main>
</div>           <!-- #view-home -->

<!-- VUE ANALYSE -->
<div id="view-analyse" hidden>
  <main class="genesis-main">
    <div class="fr-container">

      <!-- BARRE ACTIONS (alignée sur les 2 colonnes de la grille) -->
<div class="genesis-actions">
  <div>
    <button class="fr-btn fr-btn--tertiary fr-btn--icon-left" id="btn-back-home">
      <span aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
             fill="currentColor" width="1.25em" height="1.25em">
          <path d="M7.82843 10.9999H20V12.9999H7.82843L13.1924 18.3638L11.7782 19.778L4 11.9999L11.7782 4.22168L13.1924 5.63589Z"/>
        </svg>
      </span>
      Retour
    </button>
  </div>

  <div class="genesis-actions-right">
    <button id="btn-show-tuto" class="fr-btn fr-btn--secondary">
      Tutoriel
    </button>
  </div>
</div>

      <div class="genesis-grid">
        <!-- GAUCHE -->
        <section>
          <h2 class="fr-h5">Texte à analyser</h2>

          <textarea
            id="inputText"
            class="fr-input"
            rows="6"
            placeholder="Collez ici l’entête brute du courrier électronique…"></textarea>

          <fieldset class="fr-fieldset fr-mt-2w">
            <legend class="fr-fieldset__legend">
              Types d’éléments à extraire
            </legend>

            <div class="fr-fieldset__content">
              <div class="fr-checkbox-group fr-mb-1w">
                <input type="checkbox" id="chk-ip">
                <label for="chk-ip">Adresses IP</label>
              </div>

              <div class="fr-checkbox-group">
                <input type="checkbox" id="chk-mail">
                <label for="chk-mail">Adresses e-mail</label>
              </div>

              <div class="fr-checkbox-group fr-mt-1w">
                <input type="checkbox" id="chk-agent">
                <label for="chk-agent">Informations sur l'appareil de l'expéditeur</label>
              </div>
            </div>
          </fieldset>

          <button id="btn-analyze" class="fr-btn fr-mt-2w">
            Analyser
          </button>
        </section>

        <!-- DROITE -->
        <section>
          <h2 class="fr-h5">Résultats</h2>
          <div id="results" class="results fr-text--sm">
            Aucun résultat pour le moment.
          </div>
        </section>
      </div>

    </div>
  </main>
</div>

<!-- VUE TUTORIEL -->
<div id="view-tuto" hidden>
  <main class="genesis-main">
    <div class="fr-container">

      <!-- BARRE ACTIONS (même hauteur/structure que sur Analyse) -->
      <div class="fr-grid-row fr-mb-2w fr-grid-row--middle">
        <div class="fr-col">
          <button class="fr-btn fr-btn--tertiary fr-btn--icon-left" id="btn-back-analyse">
            <span aria-hidden="true">
              <svg class="btn-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                   fill="currentColor" width="1.25em" height="1.25em">
                <path d="M7.82843 10.9999H20V12.9999H7.82843L13.1924 18.3638L11.7782 19.778L4 11.9999L11.7782 4.22168L13.1924 5.63589Z"/>
              </svg>
            </span>
            Retour
          </button>
        </div>
        <div class="fr-col"></div>
      </div>

      <!-- CONTENU TUTO -->
      <div class="fr-mt-4w">
        <h1 class="fr-h3">Comment récupérer l’entête d’un courrier électronique</h1>

        <p>Pour analyser un message, GENESIS a besoin de son <strong>entête complète</strong>.</p>

        <ol class="fr-mt-2w">
          <li>Ouvrez le courrier électronique avec l'application "Messagerie Thunderbird"</li>
          <li>Utilisez le raccourci <strong>Ctrl + U</strong></li>
          <li>Copiez l’intégralité du contenu affiché</li>
          <li>Revenez sur GENESIS</li>
          <li>Collez le contenu dans le champ « Texte à analyser »</li>
        </ol>

        <p>
          Il faut bien récupérer le courrier inital sur l'appareil de la victime. Si vous transférez le message sur votre boîte professionelle, les données seront modifiées. Vous pouvez au choix :
        </p>

        <ol class="fr-mt-2w">
          <li>Ou copier le code source depuis l'appareil de la victime, en affichant l'entête du courrier électronique via le bouton menu "...".</li>
          <li>Ou télécharger le courrier sur l'appareil de la victime via le bouton "télécharger" de sa messagerie (format .eml), avant de vous l'envoyer.</li>
        </ol>
      </div>

    </div>
  </main>
</div>

<!-- DSFR JS -->
<script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.module.min.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.nomodule.min.js" nomodule></script>

<!-- SCRIPT PRINCIPAL -->
<script>
  function decodeQuotedPrintable(text) {
    return text
      .replace(/=\r?\n/g, '')
      .replace(/=([A-F0-9]{2})/gi, (_, hex) => String.fromCharCode(parseInt(hex, 16)));
  }

  const REGEX_MAIL = /\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b/g;

  function isPublicIP(ip) {
    if (ip.includes(':')) {
      const lower = ip.toLowerCase();
      if (lower === '::1') return false;
      if (lower.startsWith('fe80:')) return false;
      if (lower.startsWith('fc') || lower.startsWith('fd')) return false;
      return true;
    }

    if (
      ip.startsWith('10.') ||
      ip.startsWith('127.') ||
      ip.startsWith('192.168.') ||
      /^172\.(1[6-9]|2\d|3[0-1])\./.test(ip) ||
      ip === '0.0.0.0'
    ) return false;

    return true;
  }

  function isHumanEmail(email) {
    const e = email.trim();
    const at = e.lastIndexOf('@');
    if (at === -1) return false;

    const local = e.slice(0, at);

    const technicalPatterns = [
      /^[a-f0-9-]{32,}@/i,
      /^[a-f0-9-]{20,}@/i,
      /^[a-z0-9]{16,}@/i,
      /^[a-z]@/i,
      /^mailer-daemon@/i,
      /^postmaster@/i,
      /^no-?reply@/i,
      /^\d+(?:\.\d+){2,}\.JavaMail\./i,
      /JavaMail/i
    ];

    if (technicalPatterns.some(re => re.test(e))) return false;

    const letters = (local.match(/[a-zA-Z]/g) || []).length;
    const digits  = (local.match(/[0-9]/g) || []).length;
    const dots    = (local.match(/\./g) || []).length;

    const len = local.length;

    if (letters === 0 && dots >= 2 && digits >= 10) return false;
    if (len >= 25 && digits / Math.max(1, len) > 0.7) return false;

    return true;
  }

  function extractLastReceivedUTC(text) {
    const lines = text.split(/\r?\n/);
    let receivedBlocks = [];
    let current = null;

    for (const line of lines) {
      if (/^Received:/i.test(line)) {
        if (current) receivedBlocks.push(current);
        current = line;
      } else if (current && /^\s+/.test(line)) {
        current += ' ' + line.trim();
      } else {
        if (current) {
          receivedBlocks.push(current);
          current = null;
        }
      }
    }
    if (current) receivedBlocks.push(current);
    if (!receivedBlocks.length) return null;

    const lastReceived = receivedBlocks[receivedBlocks.length - 1];
    const dateMatch = lastReceived.match(/;\s*(.+)$/);
    if (!dateMatch) return null;

    const date = new Date(dateMatch[1]);
    if (isNaN(date.getTime())) return null;

    return date.toISOString().replace('T', ' ').replace(/\.\d{3}Z$/, ' UTC');
  }

  function getHeaderLinesForIPScan(text) {
    const lines = text.split(/\r?\n/);

    const blocks = [];
    let current = null;

    for (const line of lines) {
      if (/^(Received|X-Received):/i.test(line)) {
        if (current) blocks.push(current);
        current = line;
      } else if (current && /^\s+/.test(line)) {
        const cont = line.trim();
        const end = current.slice(-1);
        const start = cont.charAt(0);

        const ipLikeEnd = /[0-9A-Fa-f\.\:\[\]]/.test(end);
        const ipLikeStart = /[0-9A-Fa-f\.\:\[\]]/.test(start);

        current += (ipLikeEnd && ipLikeStart) ? cont : (' ' + cont);
      } else {
        if (current) {
          blocks.push(current);
          current = null;
        }
      }
    }
    if (current) blocks.push(current);

    const wantedSingles = lines.filter(l =>
      /^(Authentication-Results|Received-SPF|ARC-Authentication-Results|X-Originating-IP|X-Forwarded-For|X-Client-IP|Client-IP|X-Source-IP|X-Sender-IP|X-Remote-IP|X-Mailer):/i.test(l)
    );

    return [...blocks, ...wantedSingles];
  }

  function extractIPv4FromText(s) {
    const out = [];
    const re = /(^|[^0-9.])((?:25[0-5]|2[0-4]\d|1?\d?\d)(?:\.(?:25[0-5]|2[0-4]\d|1?\d?\d)){3})(?=$|[^0-9.])/g;

    let m;
    while ((m = re.exec(s)) !== null) out.push(m[2]);
    return out;
  }

  function extractIPv6WithOptionalPortFromText(s) {
    const out = [];

    const bracket = /\[(?:IPv6:)?([0-9a-fA-F:]{2,})\](?::(\d{1,5}))?/g;
    let m;
    while ((m = bracket.exec(s)) !== null) {
      const addr = m[1];
      const port = m[2];
      if (!isLikelyIPv6(addr)) continue;
      out.push(port ? `${addr}:${port}` : addr);
    }

    const naked = /(^|[^0-9A-Fa-f:])([0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4}){2,7}|(?:[0-9A-Fa-f]{1,4}:){1,7}:|:(?::[0-9A-Fa-f]{1,4}){1,7})(?=$|[^0-9A-Fa-f:])/g;
    while ((m = naked.exec(s)) !== null) {
      const addr = m[2];
      if (!isLikelyIPv6(addr)) continue;
      out.push(addr);
    }

    return out;
  }

  function isLikelyIPv6(v) {
    if (/^\d{1,2}:\d{2}:\d{2}$/.test(v)) return false;
    if (/^[0-9:]+$/.test(v)) return false;
    if ((v.match(/:/g) || []).length < 2) return false;
    return true;
  }

  function getHeaderSection(text) {
    const parts = text.split(/\r?\n\r?\n/);
    return parts[0] || text;
  }

  function removeTruncatedIPv4(list) {
    const ipv4 = list.filter(x => !x.includes(':'));
    const others = new Set(ipv4);

    return list.filter(ip => {
      if (ip.includes(':')) return true;

      for (const full of others) {
        if (full === ip) continue;
        if (full.length > ip.length && full.endsWith(ip)) {
          const idx = full.length - ip.length - 1;
          if (idx >= 0 && /[0-9]/.test(full[idx])) return false;
        }
      }
      return true;
    });
  }

  function normalizeIPv6(v) {
    return (v || '').toLowerCase().replace(/^\[|\]$/g, '');
  }

  function removeTruncatedIPv6(list) {
    const ipv6 = list.filter(x => x.includes(':')).map(normalizeIPv6);
    const keep = new Set(ipv6);

    for (const a of ipv6) {
      for (const b of ipv6) {
        if (a === b) continue;
        if (b.length > a.length && b.endsWith(a)) {
          const idx = b.length - a.length - 1;
          const prev = idx >= 0 ? b[idx] : '';
          if (/[0-9a-f]/i.test(prev)) keep.delete(a);
        }
      }
    }

    return list.filter(ip => !ip.includes(':') || keep.has(normalizeIPv6(ip)));
  }

  function extractIPsFromHeaders(text) {
    const headerText = getHeaderSection(text);
    const linesToScan = getHeaderLinesForIPScan(headerText);

    let found = [];
    for (const line of linesToScan) {
      found.push(...extractIPv4FromText(line));
      found.push(...extractIPv6WithOptionalPortFromText(line));
    }

    found = removeTruncatedIPv4(found);
    found = removeTruncatedIPv6(found);
    return found;
  }

  function extractUserAgentInfo(text) {
    const lines = text.split(/\r?\n/);

    const mimeLine = lines.find(l => /^mime-version:/i.test(l));
    const xMailerLine = lines.find(l => /^x-mailer:/i.test(l));
    const uaLine = lines.find(l => /^user-agent:/i.test(l) || /^x-user-agent:/i.test(l));

    let value = '';
    if (mimeLine && /\(.*\)/.test(mimeLine)) value = mimeLine.match(/\((.*)\)/)[1];
    else if (xMailerLine) value = xMailerLine.split(':').slice(1).join(':').trim();
    else if (uaLine) value = uaLine.split(':').slice(1).join(':').trim();

    if (!value) {
      const full = text;
      if (/envoy[eé]\s+à\s+partir\s+de\s+outlook\s+pour\s+ios/i.test(full) || /sent from outlook for ios/i.test(full)) {
        return { raw: 'Outlook pour iOS', os: 'iOS (Apple)', app: 'Microsoft Outlook', version: '' };
      }
      if (/envoy[eé]\s+à\s+partir\s+de\s+outlook\s+pour\s+android/i.test(full) || /sent from outlook for android/i.test(full)) {
        return { raw: 'Outlook pour Android', os: 'Android', app: 'Microsoft Outlook', version: '' };
      }
      return null;
    }

    let os = 'Inconnu';
    let app = 'Inconnue';
    let version = '';

    if (/outlook\s+pour\s+ios/i.test(value)) {
      os = 'iOS (Apple)';
      app = 'Microsoft Outlook';
    } else if (/outlook\s+pour\s+android/i.test(value)) {
      os = 'Android';
      app = 'Microsoft Outlook';
    } else if (/outlook/i.test(value)) {
      os = 'Windows';
      app = 'Microsoft Outlook';
      const v = value.match(/outlook[\s\/]?([\d.]+)/i);
      if (v) version = v[1];
    } else if (/mac os x mail/i.test(value) || /apple mail/i.test(value)) {
      os = 'macOS (Apple)';
      app = 'Apple Mail';
      const v = value.match(/mail\s([\d.]+)/i);
      if (v) version = v[1];
    } else if (/thunderbird\/([\d.]+)/i.test(value)) {
      app = 'Mozilla Thunderbird';
      version = value.match(/thunderbird\/([\d.]+)/i)[1];
      if (/windows/i.test(value)) os = 'Windows';
      else if (/mac os x|macintosh/i.test(value)) os = 'macOS';
      else if (/linux/i.test(value)) os = 'Linux';
    }

    return { raw: value, os, app, version };
  }

  document.getElementById('btn-analyze').addEventListener('click', () => {
    const rawText = document.getElementById('inputText').value;
    const text = decodeQuotedPrintable(rawText);

    const wantIP = document.getElementById('chk-ip').checked;
    const wantMail = document.getElementById('chk-mail').checked;
    const wantAgent = document.getElementById('chk-agent').checked;

    const output = document.getElementById('results');
    output.innerHTML = '';

    if (!wantIP && !wantMail && !wantAgent) {
      output.textContent = 'Sélectionnez au moins un type d’analyse.';
      return;
    }
    if ((wantIP || wantMail || wantAgent) && !text.trim()) {
      output.textContent = 'Veuillez coller une entête avant de lancer l’analyse.';
      return;
    }

    const blocks = [];

    if (wantIP) {
      const allIPs = extractIPsFromHeaders(text);

      const publicIPs = allIPs.filter(isPublicIP);
      const technicalIPs = allIPs.filter(ip => !isPublicIP(ip));

      const uniqPublic = [...new Set(publicIPs)].sort();
      const uniqTech = [...new Set(technicalIPs)].sort();

      const dateUTC = extractLastReceivedUTC(text) || 'Horodatage non trouvé';

      let html = `
        <strong>Adresses IP (${uniqPublic.length})</strong><br>
        <div class="fr-mb-1w fr-text--sm">Horodatage : ${dateUTC}</div><br>
      `;

      html += uniqPublic.length
        ? uniqPublic.map(ip => `• ${ip}`).join('<br>')
        : 'Aucune adresse IP publique trouvée';

      if (uniqTech.length) {
        html += `
          <details class="fr-mt-2w">
            <summary>Voir les résultats techniques (${uniqTech.length})</summary>
            <div class="fr-mt-1w fr-text--sm">
              ${uniqTech.map(ip => `• ${ip}`).join('<br>')}
            </div>
          </details>
        `;
      }

      blocks.push(html);
    }

    if (wantMail) {
      const allMails = text.match(REGEX_MAIL) || [];

      const humanMails = allMails.filter(isHumanEmail);
      const technicalMails = allMails.filter(m => !isHumanEmail(m));

      const uniqHuman = [...new Set(humanMails)].sort();
      const uniqTech = [...new Set(technicalMails)].sort();

      let html = `<strong>Adresses e-mail (${uniqHuman.length})</strong><br><br>`;
      html += uniqHuman.length ? uniqHuman.join('<br>') : 'Aucune adresse e-mail pertinente trouvée';

      if (uniqTech.length) {
        html += `
          <details class="fr-mt-2w">
            <summary>Voir les résultats techniques (${uniqTech.length})</summary>
            <div class="fr-mt-1w fr-text--sm">
              ${uniqTech.join('<br>')}
            </div>
          </details>
        `;
      }

      blocks.push(html);
    }

    if (wantAgent) {
      const agentInfo = extractUserAgentInfo(text);

      if (!agentInfo) {
        blocks.push(`<strong>Appareil utilisé et application de l'expéditeur</strong><br>Aucune information trouvée`);
      } else {
        blocks.push(
          `<strong>Appareil utilisé et application de l'expéditeur</strong><br>
          <ul>
            <li><strong>Système :</strong> ${agentInfo.os}</li>
            <li><strong>Application :</strong> ${agentInfo.app}</li>
            ${agentInfo.version ? `<li><strong>Version :</strong> ${agentInfo.version}</li>` : ''}
            <li><strong>Chaîne brute :</strong> <code>${agentInfo.raw}</code></li>
          </ul>`
        );
      }
    }

    output.innerHTML = blocks.join('<br><br>');
  });
</script>

<!-- SCRIPT NAVIGATION -->
<script>
  const viewHome    = document.getElementById('view-home');
  const viewAnalyse = document.getElementById('view-analyse');
  const viewTuto    = document.getElementById('view-tuto');

  const btnShowTuto    = document.getElementById('btn-show-tuto');
  const btnBackAnalyse = document.getElementById('btn-back-analyse');
  const btnBackHome    = document.getElementById('btn-back-home');

  function showView(target) {
    viewHome.hidden = true;
    viewAnalyse.hidden = true;
    viewTuto.hidden = true;

    target.hidden = false;
    window.scrollTo(0, 0);
  }

  // ✅ Accueil → Analyse (CARTE cliquable)
  // On écoute tout le document et on récupère le lien/clique cible même si tu cliques sur un élément enfant
  document.addEventListener('click', (e) => {
    const goAnalyse = e.target.closest('#btn-go-analyse'); // l'ID doit être sur le <a> de la carte
    if (goAnalyse) {
      e.preventDefault();
      showView(viewAnalyse);
      return;
    }

    const goReq = e.target.closest('#btn-go-req'); // carte V2
    if (goReq) {
      e.preventDefault(); // on bloque la navigation
      return;
    }
  });

  // Analyse → Tutoriel
  btnShowTuto?.addEventListener('click', () => showView(viewTuto));

  // Tutoriel → Analyse
  btnBackAnalyse?.addEventListener('click', () => showView(viewAnalyse));

  // Analyse → Accueil
  btnBackHome?.addEventListener('click', () => showView(viewHome));
</script>

<footer class="genesis-credit">
  GENESIS NG 2026 - MDC HUGO BRES--MALANCHERE - DEMO ADI 2026
</footer>

</body>
</html>
