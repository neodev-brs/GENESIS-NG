<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>GENESIS NG – Outil d'analyse de la preuve numérique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://www.interieur.gouv.fr/themes/custom/dsfr/src/images/logo/favicon.png">

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/utility/utilities.min.css">

  <style>
    body { margin: 0; background: #fff; }
    .fr-header, .fr-header__brand { filter: none !important; }

    .genesis-main { padding: 2rem 0; }

    .genesis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .btn-align-right {
  display: inline-flex;
  margin-left: auto;
}

/* Barre actions alignée EXACTEMENT sur les colonnes Texte/Résultats */
.genesis-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;              /* même gap que .genesis-grid */
  align-items: center;
  margin-bottom: 2rem;    /* équivalent à fr-mb-2w */
}

.genesis-actions-right {
  display: flex;
  justify-content: flex-end; /* colle le bouton à droite */
}

/* Alignement vertical flèche + texte dans les boutons retour */
.fr-btn {
  display: inline-flex;
  align-items: center;
}

    textarea {
      min-height: 360px;
      font-family: monospace;
    }

    .results {
      min-height: 360px;
      padding: 1rem;
      border: 1px solid var(--border-default-grey);
      background: var(--background-alt-grey);
      overflow-y: auto;
    }

    .genesis-credit {
      position: fixed;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: #666;
      opacity: 0.2;
      pointer-events: none;
      user-select: none;
    }

    /* Petite aide: aligne le SVG comme dans ton exemple */
    .btn-svg {
      vertical-align: middle;
    }

    /* Alignement vertical icône + texte dans les boutons Retour */
.fr-btn.fr-btn--icon-left {
  display: inline-flex;      /* sécurité */
  align-items: center;       /* centre verticalement */
  gap: 0.5rem;               /* espace icône/texte (ajuste si tu veux) */
}

.fr-btn.fr-btn--icon-left > span[aria-hidden="true"] {
  display: inline-flex;      /* évite le “baseline” */
  align-items: center;
}

.fr-btn.fr-btn--icon-left svg {
  display: block;            /* supprime les décalages baseline */
}

/* === Cartes accueil (DSFR vertical) === */
.genesis-card-img {
  display: flex;
  justify-content: center;
  padding: 1.25rem;     /* respiration */
}

/* Taille du SVG (ne change pas la carte, juste l’image) */
.genesis-card-img img {
  width: 210px;
  height: 120px;
  object-fit: contain;
  display: block;
}

/* Badge : aligné à gauche */
.genesis-badge {
  display: inline-flex;
  align-self: flex-start;
}

/* Slot badge fantôme (réserve la hauteur pour aligner les titres) */
.genesis-badge--ghost {
  visibility: hidden;
  pointer-events: none;
}

  </style>
</head>

<body>

<!-- HEADER OFFICIEL -->
<header role="banner" class="fr-header">
  <div class="fr-header__body">
    <div class="fr-container">
      <div class="fr-header__body-row">
        <div class="fr-header__brand fr-enlarge-link">
          <div class="fr-header__brand-top">
            <div class="fr-header__logo">
              <p class="fr-logo">Ministère<br>de l’Intérieur</p>
            </div>
          </div>
          <div class="fr-header__service">
            <p class="fr-header__service-title">GENESIS NG</p>
            <p class="fr-header__service-tagline">
              Outil d’analyse de la preuve numérique
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- ACCUEIL -->
<div id="view-home">
  <main class="genesis-main">
    <div class="fr-container">
      <div class="fr-grid-row fr-grid-row--center fr-mt-1w">
        <div class="fr-col-12 fr-col-md-10 fr-col-lg-8">
          <h1 class="fr-h3 fr-mb-2w">Choisir un module</h1>
          <p class="fr-text--lg fr-mb-4w">
            Sélectionnez le type de contenu à analyser.
          </p>

          <div class="fr-grid-row fr-grid-row--gutters">

            <!-- CARTE 1 : Entête de mail (VERTICALE) -->
            <div class="fr-col-12 fr-col-md-6">
              <div class="fr-card fr-enlarge-link">

                <!-- Image / SVG -->
                <div class="fr-card__img genesis-card-img">
                  <img src="assets/svg/mail-send.svg" alt="" aria-hidden="true">
                </div>

                <div class="fr-card__body">
                  <div class="fr-card__content">

                    <!-- Slot badge fantôme pour aligner les titres -->
                    <p class="fr-badge fr-badge--new fr-badge--icon-lightning-line fr-badge--sm fr-mb-2v genesis-badge genesis-badge--ghost"
                       aria-hidden="true">
                      Nouveau
                    </p>

                    <h3 class="fr-card__title">
                      <a class="fr-card__link" href="#" id="btn-go-analyse">
                        Entête de mail
                      </a>
                    </h3>

                    <p class="fr-card__desc">
                      Extraction d’IP, adresses e-mails et informations sur l’appareil expéditeur.
                    </p>

                    <div class="fr-card__end">
                      <p class="fr-card__detail">
                        Ouvrir le module
                      </p>
                    </div>

                  </div>
                </div>

              </div>
            </div>

            <!-- CARTE 2 : Résultat réquisition -->
            <div class="fr-col-12 fr-col-md-6">
              <div class="fr-card fr-enlarge-link" aria-disabled="true">

                <!-- Image / SVG -->
                <div class="fr-card__img genesis-card-img">
                  <img src="assets/svg/data-visualization.svg" alt="" aria-hidden="true">
                </div>

                <div class="fr-card__body">
                  <div class="fr-card__content">

                    <!-- Badge AU-DESSUS (gauche) -->
                    <p class="fr-badge fr-badge--new fr-badge--icon-lightning-line fr-badge--sm fr-mb-2v genesis-badge">
                      Nouveau
                    </p>

                    <h3 class="fr-card__title">
                      <a class="fr-card__link" href="#" id="btn-go-req" aria-disabled="true" tabindex="-1">
                        Résultat de réquisition
                      </a>
                    </h3>

                    <p class="fr-card__desc">
                      Extraction depuis un résultat de réquisition (mail, IP, téléphone, adresse…)
                    </p>

                    <div class="fr-card__end">
                      <p class="fr-card__detail">
                        Formats : “.pdf, .odt, .calc, .csv, .txt…”
                      </p>
                      <p class="fr-card__detail">
                        Ouvrir le module
                      </p>
                    </div>

                  </div>
                </div>

              </div>
            </div>

          </div><!-- /.fr-grid-row -->
        </div>
      </div>
    </div>
  </main>
</div>

<!-- VUE ANALYSE -->
<div id="view-analyse" hidden>
  <main class="genesis-main">
    <div class="fr-container">

      <!-- BARRE ACTIONS (alignée sur les 2 colonnes de la grille) -->
<div class="genesis-actions">
  <div>
    <button class="fr-btn fr-btn--tertiary fr-btn--icon-left" id="btn-back-home">
      <span aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
             fill="currentColor" width="1.25em" height="1.25em">
          <path d="M7.82843 10.9999H20V12.9999H7.82843L13.1924 18.3638L11.7782 19.778L4 11.9999L11.7782 4.22168L13.1924 5.63589Z"/>
        </svg>
      </span>
      Retour
    </button>
  </div>

  <div class="genesis-actions-right">
    <button id="btn-show-tuto" class="fr-btn fr-btn--secondary">
      Tutoriel
    </button>
  </div>
</div>

      <div class="genesis-grid">
        <!-- GAUCHE -->
        <section>
          <h2 class="fr-h5">Texte à analyser</h2>

          <textarea
            id="inputText"
            class="fr-input"
            rows="6"
            placeholder="Collez ici l’entête brute du courrier électronique…"></textarea>

          <fieldset class="fr-fieldset fr-mt-2w">
            <legend class="fr-fieldset__legend">
              Types d’éléments à extraire
            </legend>

            <div class="fr-fieldset__content">
              <div class="fr-checkbox-group fr-mb-1w">
                <input type="checkbox" id="chk-ip">
                <label for="chk-ip">Adresses IP</label>
              </div>

              <div class="fr-checkbox-group">
                <input type="checkbox" id="chk-mail">
                <label for="chk-mail">Adresses e-mail</label>
              </div>

              <div class="fr-checkbox-group fr-mt-1w">
                <input type="checkbox" id="chk-agent">
                <label for="chk-agent">Informations sur l'appareil de l'expéditeur</label>
              </div>
            </div>
          </fieldset>

          <button id="btn-analyze" class="fr-btn fr-mt-2w">
            Analyser
          </button>
        </section>

        <!-- DROITE -->
        <section>
          <h2 class="fr-h5">Résultats</h2>
          <div id="results" class="results fr-text--sm">
            Aucun résultat pour le moment.
          </div>
        </section>
      </div>

    </div>
  </main>
</div>

<!-- VUE REQUISITION -->
<div id="view-req" hidden>
  <main class="genesis-main">
    <div class="fr-container">

      <!-- BARRE ACTIONS (même structure que Analyse) -->
      <div class="genesis-actions">
        <div>
          <button class="fr-btn fr-btn--tertiary fr-btn--icon-left" id="btn-back-home-from-req">
            <span aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                   fill="currentColor" width="1.25em" height="1.25em">
                <path d="M7.82843 10.9999H20V12.9999H7.82843L13.1924 18.3638L11.7782 19.778L4 11.9999L11.7782 4.22168L13.1924 5.63589Z"/>
              </svg>
            </span>
            Retour
          </button>
        </div>

        <div class="genesis-actions-right">
          <button id="btn-show-tuto-from-req" class="fr-btn fr-btn--secondary">
            Tutoriel
          </button>
        </div>
      </div>

      <div class="genesis-grid">
        <!-- GAUCHE -->
        <section>
          <h2 class="fr-h5">Texte à analyser</h2>

          <textarea
            id="inputReqText"
            class="fr-input"
            rows="4"
            placeholder="Collez ici le contenu du résultat de réquisition…"></textarea>

          <fieldset class="fr-fieldset fr-mt-2w">
            <legend class="fr-fieldset__legend">
              Types d’éléments à extraire
            </legend>

           <div class="fr-fieldset__content">
  <div class="fr-checkbox-group fr-mb-1w">
    <input type="checkbox" id="req-chk-mail">
    <label for="req-chk-mail">Adresse e-mail</label>
  </div>

  <div class="fr-checkbox-group fr-mb-1w">
    <input type="checkbox" id="req-chk-ip">
    <label for="req-chk-ip">Adresse IP</label>
  </div>

  <div class="fr-checkbox-group fr-mb-1w">
    <input type="checkbox" id="req-chk-postal">
    <label for="req-chk-postal">Adresse postale</label>
  </div>

  <div class="fr-checkbox-group">
    <input type="checkbox" id="req-chk-phone">
    <label for="req-chk-phone">Téléphone</label>
  </div>
</div>

          </fieldset>

          <button id="btn-req-analyze" class="fr-btn fr-mt-2w">
            Analyser
          </button>
        </section>

        <!-- DROITE -->
        <section>
          <h2 class="fr-h5">Résultats</h2>
          <div id="req-results" class="results fr-text--sm">
            Aucun résultat pour le moment.
          </div>
        </section>
      </div>

    </div>
  </main>
</div>

<!-- VUE TUTORIEL -->
<div id="view-tuto" hidden>
  <main class="genesis-main">
    <div class="fr-container">

      <!-- BARRE ACTIONS (même hauteur/structure que sur Analyse) -->
      <div class="fr-grid-row fr-mb-2w fr-grid-row--middle">
        <div class="fr-col">
          <button class="fr-btn fr-btn--tertiary fr-btn--icon-left" id="btn-back-analyse">
            <span aria-hidden="true">
              <svg class="btn-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                   fill="currentColor" width="1.25em" height="1.25em">
                <path d="M7.82843 10.9999H20V12.9999H7.82843L13.1924 18.3638L11.7782 19.778L4 11.9999L11.7782 4.22168L13.1924 5.63589Z"/>
              </svg>
            </span>
            Retour
          </button>
        </div>
        <div class="fr-col"></div>
      </div>

      <!-- CONTENU TUTO -->
      <div class="fr-mt-4w">
        <h1 class="fr-h3">Comment récupérer l’entête d’un courrier électronique</h1>

        <p>Pour analyser un message, GENESIS a besoin de son <strong>entête complète</strong>.</p>

        <ol class="fr-mt-2w">
          <li>Ouvrez le courrier électronique avec l'application "Messagerie Thunderbird"</li>
          <li>Utilisez le raccourci <strong>Ctrl + U</strong></li>
          <li>Copiez l’intégralité du contenu affiché</li>
          <li>Revenez sur GENESIS</li>
          <li>Collez le contenu dans le champ « Texte à analyser »</li>
        </ol>

        <p>
          Il faut bien récupérer le courrier inital sur l'appareil de la victime. Si vous transférez le message sur votre boîte professionelle, les données seront modifiées. Vous pouvez au choix :
        </p>

        <ol class="fr-mt-2w">
          <li>Ou copier le code source depuis l'appareil de la victime, en affichant l'entête du courrier électronique via le bouton menu "...".</li>
          <li>Ou télécharger le courrier sur l'appareil de la victime via le bouton "télécharger" de sa messagerie (format .eml), avant de vous l'envoyer.</li>
        </ol>
      </div>

    </div>
  </main>
</div>

<!-- VUE TUTORIEL REQUISITION -->
<div id="view-tuto-req" hidden>
  <main class="genesis-main">
    <div class="fr-container">

      <!-- BARRE ACTIONS (même structure que les autres) -->
      <div class="fr-grid-row fr-mb-2w fr-grid-row--middle">
        <div class="fr-col">
          <button class="fr-btn fr-btn--tertiary fr-btn--icon-left" id="btn-back-req">
            <span aria-hidden="true">
              <svg class="btn-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                   fill="currentColor" width="1.25em" height="1.25em">
                <path d="M7.82843 10.9999H20V12.9999H7.82843L13.1924 18.3638L11.7782 19.778L4 11.9999L11.7782 4.22168L13.1924 5.63589Z"/>
              </svg>
            </span>
            Retour
          </button>
        </div>
        <div class="fr-col"></div>
      </div>

      <!-- CONTENU TUTO REQUISITION -->
      <div class="fr-mt-4w">
        <h1 class="fr-h3">Comment exploiter un résultat de réquisition</h1>

        <p>
          Ce module sert à extraire rapidement des informations depuis un <strong>copier-coller</strong>
          de résultat de réquisition (PDF/ODT/CSV/TXT), pour les rendre lisibles et exploitables.
        </p>

        <h2 class="fr-h5 fr-mt-4w">1) Récupérer le contenu</h2>
        <ol class="fr-mt-2w">
          <li>Ouvre le document (PDF, ODT, CSV, TXT…).</li>
          <li>Sélectionne le contenu utile (évite les pages de garde, signatures énormes, etc.).</li>
          <li>Copie le texte (<strong>Ctrl + C</strong>).</li>
          <li>Colle dans le champ <strong>Texte à analyser</strong> du module Réquisition.</li>
        </ol>

        <h2 class="fr-h5 fr-mt-4w">2) Choisir quoi extraire</h2>
        <p class="fr-mb-2w">
          Coche uniquement ce qui t’intéresse :
        </p>
        <ul>
          <li><strong>Adresse e-mail</strong> : identifiants de comptes, contacts, correspondants.</li>
          <li><strong>Adresse IP</strong> : IP publiques, journaux de connexion, traces techniques.</li>
          <li><strong>Adresse postale</strong> : domiciliation, livraison, facturation.</li>
          <li><strong>Téléphone</strong> : numéros, contacts, identifiants mobiles.</li>
        </ul>

        <h2 class="fr-h5 fr-mt-4w">3) Lancer l’analyse</h2>
        <ol class="fr-mt-2w">
          <li>Coche au moins un type.</li>
          <li>Clique sur <strong>Analyser</strong>.</li>
          <li>Les résultats apparaissent à droite.</li>
        </ol>

        <div class="fr-callout fr-mt-4w">
          <h3 class="fr-callout__title">Conseil</h3>
          <p class="fr-callout__text">
            Plus ton texte est “propre” (sans tableaux cassés / colonnes mélangées),
            plus l’extraction sera fiable. Si besoin, passe par un copier-coller “texte brut”.
          </p>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- DSFR JS -->
<script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.module.min.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.nomodule.min.js" nomodule></script>

<!-- SCRIPT PRINCIPAL -->
<script>
  function decodeQuotedPrintable(text) {
    return text
      .replace(/=\r?\n/g, '')
      .replace(/=([A-F0-9]{2})/gi, (_, hex) => String.fromCharCode(parseInt(hex, 16)));
  }

  const REGEX_MAIL = /\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b/g;

  /* =========================
     OUTILS (communs)
  ========================= */
  function escapeHTML(s) {
    return String(s || '')
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function isPublicIP(ip) {
    if (ip.includes(':')) {
      const lower = ip.toLowerCase();
      if (lower === '::1') return false;
      if (lower.startsWith('fe80:')) return false;
      if (lower.startsWith('fc') || lower.startsWith('fd')) return false;
      return true;
    }

    if (
      ip.startsWith('10.') ||
      ip.startsWith('127.') ||
      ip.startsWith('192.168.') ||
      /^172\.(1[6-9]|2\d|3[0-1])\./.test(ip) ||
      ip === '0.0.0.0'
    ) return false;

    return true;
  }

  function isHumanEmail(email) {
    const e = email.trim();
    const at = e.lastIndexOf('@');
    if (at === -1) return false;

    const local = e.slice(0, at);

    const technicalPatterns = [
      /^[a-f0-9-]{32,}@/i,
      /^[a-f0-9-]{20,}@/i,
      /^[a-z0-9]{16,}@/i,
      /^[a-z]@/i,
      /^mailer-daemon@/i,
      /^postmaster@/i,
      /^no-?reply@/i,
      /^\d+(?:\.\d+){2,}\.JavaMail\./i,
      /JavaMail/i
    ];

    if (technicalPatterns.some(re => re.test(e))) return false;

    const letters = (local.match(/[a-zA-Z]/g) || []).length;
    const digits  = (local.match(/[0-9]/g) || []).length;
    const dots    = (local.match(/\./g) || []).length;

    const len = local.length;

    if (letters === 0 && dots >= 2 && digits >= 10) return false;
    if (len >= 25 && digits / Math.max(1, len) > 0.7) return false;

    return true;
  }

  /* =========================
     IP extraction (texte libre)
  ========================= */
  function extractIPv4FromText(s) {
    const out = [];
    const re = /(^|[^0-9.])((?:25[0-5]|2[0-4]\d|1?\d?\d)(?:\.(?:25[0-5]|2[0-4]\d|1?\d?\d)){3})(?=$|[^0-9.])/g;
    let m;
    while ((m = re.exec(s)) !== null) out.push(m[2]);
    return out;
  }

  function isLikelyIPv6(v) {
    if (/^\d{1,2}:\d{2}:\d{2}$/.test(v)) return false;
    if (/^[0-9:]+$/.test(v)) return false;
    if ((v.match(/:/g) || []).length < 2) return false;
    return true;
  }

  function extractIPv6WithOptionalPortFromText(s) {
    const out = [];

    const bracket = /\[(?:IPv6:)?([0-9a-fA-F:]{2,})\](?::(\d{1,5}))?/g;
    let m;
    while ((m = bracket.exec(s)) !== null) {
      const addr = m[1];
      const port = m[2];
      if (!isLikelyIPv6(addr)) continue;
      out.push(port ? `${addr}:${port}` : addr);
    }

    const naked = /(^|[^0-9A-Fa-f:])([0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4}){2,7}|(?:[0-9A-Fa-f]{1,4}:){1,7}:|:(?::[0-9A-Fa-f]{1,4}){1,7})(?=$|[^0-9A-Fa-f:])/g;
    while ((m = naked.exec(s)) !== null) {
      const addr = m[2];
      if (!isLikelyIPv6(addr)) continue;
      out.push(addr);
    }

    return out;
  }

  function removeTruncatedIPv4(list) {
    const ipv4 = list.filter(x => !x.includes(':'));
    const others = new Set(ipv4);

    return list.filter(ip => {
      if (ip.includes(':')) return true;

      for (const full of others) {
        if (full === ip) continue;
        if (full.length > ip.length && full.endsWith(ip)) {
          const idx = full.length - ip.length - 1;
          if (idx >= 0 && /[0-9]/.test(full[idx])) return false;
        }
      }
      return true;
    });
  }

  function normalizeIPv6(v) {
    return (v || '').toLowerCase().replace(/^\[|\]$/g, '');
  }

  function removeTruncatedIPv6(list) {
    const ipv6 = list.filter(x => x.includes(':')).map(normalizeIPv6);
    const keep = new Set(ipv6);

    for (const a of ipv6) {
      for (const b of ipv6) {
        if (a === b) continue;
        if (b.length > a.length && b.endsWith(a)) {
          const idx = b.length - a.length - 1;
          const prev = idx >= 0 ? b[idx] : '';
          if (/[0-9a-f]/i.test(prev)) keep.delete(a);
        }
      }
    }

    return list.filter(ip => !ip.includes(':') || keep.has(normalizeIPv6(ip)));
  }

  function extractIPsFromPlainText(text) {
    let found = [];
    found.push(...extractIPv4FromText(text));
    found.push(...extractIPv6WithOptionalPortFromText(text));
    found = removeTruncatedIPv4(found);
    found = removeTruncatedIPv6(found);
    return [...new Set(found)].sort();
  }

  /* =========================
     REQUISITION – REGEX (AVANT les listeners)
  ========================= */
  const REGEX_PHONE =
    /(?:\+?\d{1,3}[\s.\-()]*)?(?:0|\(?\d{1,2}\)?)[\s.\-()]*\d(?:[\s.\-]*\d){7,12}\b/g;

  const REGEX_ADDRESS_LINE = new RegExp(
    String.raw`^\s*` +
    String.raw`(\d{1,5}\s*(?:bis|ter|quater)?\s+` +
    String.raw`(?:rue|avenue|av\.?|boulevard|bd\.?|impasse|chemin|route|allée|allee|place|quai|cours|voie|square|résidence|residence)\s+` +
    String.raw`[^\n,]{4,})` +
    String.raw`(?:[,\s]+(\d{5})\s+([A-Za-zÀ-ÖØ-öø-ÿ'’ \-]{2,}))?\s*$`,
    "i"
  );

  function normalizePhoneFRDots(raw) {
    let digits = (raw || '').replace(/\D/g, '');
    if (!digits) return null;

    if (digits.startsWith('0033')) digits = '33' + digits.slice(4);
    if (digits.startsWith('33')) digits = '0' + digits.slice(2);

    if (digits.length !== 10 || digits[0] !== '0') return null;
    return digits.match(/.{1,2}/g).join('.');
  }

  function extractPostalAddressesStructured(text) {
  const rawLines = text.split(/\r?\n/);

  // garde les lignes même si elles contiennent des TAB, mais vire les vides
  const lines = rawLines.map(l => (l ?? '').trim()).filter(Boolean);

  const out = [];
  const seen = new Set();

  const STREET_HINT = /\b(rue|avenue|av\.?|boulevard|bd\.?|impasse|chemin|route|all[ée]e|place|quai|cours|voie|square|résidence|residence)\b/i;

  function normSpaces(s) {
    return (s || '').replace(/\s{2,}/g, ' ').trim();
  }

  function addRow(adresse, ville, codePostal) {
    adresse = normSpaces(adresse);
    ville = normSpaces(ville);
    codePostal = (codePostal || '').trim();

    if (!adresse) return;

    const key = `${adresse.toLowerCase()}|${(ville || '').toLowerCase()}|${codePostal}`;
    if (seen.has(key)) return;
    seen.add(key);

    out.push({ adresse, ville, codePostal });
  }

  // essaie de parser une ligne "complète" (virgules / tabs / espaces)
  function parseLine(line) {
    const s = normSpaces(line);

    // 1) cas "Excel copié" => TAB (adresse / ville / cp ou adresse / cp / ville)
    if (s.includes('\t')) {
      const cells = s.split('\t').map(c => normSpaces(c)).filter(Boolean);
      if (cells.length >= 2) {
        const cpIdx = cells.findIndex(c => /\b\d{5}\b/.test(c));
        const cp = cpIdx >= 0 ? (cells[cpIdx].match(/\b\d{5}\b/) || [''])[0] : '';

        // ville = cellule non-CP la plus “lettres”, souvent juste à côté
        const candidates = cells.map((c, i) => ({ c, i }))
          .filter(x => x.i !== cpIdx);

        let ville = '';
        for (const cand of candidates) {
          if (/[A-Za-zÀ-ÖØ-öø-ÿ]/.test(cand.c) && !/\d/.test(cand.c)) {
            ville = cand.c;
            break;
          }
        }

        // adresse = tout ce qui reste (surtout le début)
        const adresse = candidates
          .filter(x => x.c !== ville)
          .map(x => x.c)
          .join(' ')
          .trim();

        // si adresse vide, on prend le premier champ
        addRow(adresse || cells[0], ville, cp);
        return true;
      }
    }

    // 2) cas "virgules" => "... , Ville, FR 27400"
    if (s.includes(',')) {
      const parts = s.split(',').map(p => normSpaces(p)).filter(Boolean);

      // on cherche un CP dans la dernière partie
      const last = parts[parts.length - 1] || '';
      const mcp = last.match(/\b(\d{5})\b/);

      if (mcp && parts.length >= 2) {
        const cp = mcp[1];

        // ville : souvent l’avant-dernière partie
        let ville = parts[parts.length - 2] || '';

        // adresse : tout avant la ville
        let adresse = parts.slice(0, -2).join(' ').trim();

        // cas "24, Allée X, Ville, FR 76480" => adresse = "24 Allée X"
        // si adresse trop court, on concat plus intelligemment
        if (parts.length >= 3 && (!adresse || adresse.length < 4)) {
          adresse = parts.slice(0, -2).join(' ').trim();
        }

        addRow(adresse, ville, cp);
        return true;
      }

      // cas "Adresse, Ville" sans CP : on garde partiel si ça ressemble à une voie
      if (parts.length >= 2 && STREET_HINT.test(s)) {
        const adresse = parts.slice(0, -1).join(' ').trim();
        const ville = parts[parts.length - 1].trim();
        addRow(adresse, ville, '');
        return true;
      }
    }

    // 3) cas "Adresse 27400 Louviers" (CP + ville sur la même ligne)
    // ou "27400 Louviers" seul
    let m = s.match(/^(.+?)\s+(\d{5})\s+(.+)$/);
    if (m) {
      addRow(m[1], m[3], m[2]);
      return true;
    }

    m = s.match(/^(\d{5})\s+(.+)$/);
    if (m) {
      // CP + ville, sans adresse => pas tout seul (on le traite en "ligne suivante" ailleurs)
      return false;
    }

    // 4) ligne "adresse" seule : on la traite en "ligne suivante" si next = CP VILLE
    return false;
  }

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // on tente parse direct
    const ok = parseLine(line);
    if (ok) continue;

    // si ça ressemble à une adresse (voie) et que la ligne suivante est "CP VILLE"
    if (STREET_HINT.test(line) && lines[i + 1]) {
      const next = normSpaces(lines[i + 1]);
      const m2 = next.match(/^(\d{5})\s+(.+)$/);
      if (m2) {
        addRow(line, m2[2], m2[1]);
        i++; // on consomme la ligne CP/VILLE
        continue;
      }
    }

    // si ça commence par numéro + voie mais sans CP/Ville, on garde partiel
    if (/^\d{1,5}\s*(bis|ter|quater)?\b/i.test(line) && STREET_HINT.test(line)) {
      addRow(line, '', '');
      continue;
    }
  }

  out.sort((a, b) => {
    const acp = a.codePostal || '';
    const bcp = b.codePostal || '';
    if (acp !== bcp) return acp.localeCompare(bcp);
    const av = (a.ville || '').localeCompare(b.ville || '');
    if (av !== 0) return av;
    return (a.adresse || '').localeCompare(b.adresse || '');
  });

  return out;
}

  /* =========================
     LISTENERS – ANALYSE ENTETE
  ========================= */
  document.getElementById('btn-analyze')?.addEventListener('click', () => {
    const rawText = document.getElementById('inputText')?.value || '';
    const text = decodeQuotedPrintable(rawText);

    const wantIP = document.getElementById('chk-ip')?.checked;
    const wantMail = document.getElementById('chk-mail')?.checked;
    const wantAgent = document.getElementById('chk-agent')?.checked;

    const output = document.getElementById('results');
    if (!output) return;
    output.innerHTML = '';

    if (!wantIP && !wantMail && !wantAgent) {
      output.textContent = 'Sélectionnez au moins un type d’analyse.';
      return;
    }
    if (!text.trim()) {
      output.textContent = 'Veuillez coller une entête avant de lancer l’analyse.';
      return;
    }

    const blocks = [];

    if (wantIP) {
      const allIPs = extractIPsFromPlainText(text);
      const publicIPs = allIPs.filter(isPublicIP);
      const technicalIPs = allIPs.filter(ip => !isPublicIP(ip));

      const uniqPublic = [...new Set(publicIPs)].sort();
      const uniqTech = [...new Set(technicalIPs)].sort();

      let html = `<strong>Adresses IP (${uniqPublic.length})</strong><br><br>`;
      html += uniqPublic.length ? uniqPublic.map(ip => `• ${ip}`).join('<br>') : 'Aucune adresse IP publique trouvée';

      if (uniqTech.length) {
        html += `
          <details class="fr-mt-2w">
            <summary>Voir les résultats techniques (${uniqTech.length})</summary>
            <div class="fr-mt-1w fr-text--sm">
              ${uniqTech.map(ip => `• ${ip}`).join('<br>')}
            </div>
          </details>
        `;
      }
      blocks.push(html);
    }

    if (wantMail) {
      const allMails = text.match(REGEX_MAIL) || [];
      const humanMails = allMails.filter(isHumanEmail);
      const technicalMails = allMails.filter(m => !isHumanEmail(m));

      const uniqHuman = [...new Set(humanMails)].sort();
      const uniqTech  = [...new Set(technicalMails)].sort();

      let html = `<strong>Adresses e-mail (${uniqHuman.length})</strong><br><br>`;
      html += uniqHuman.length ? uniqHuman.join('<br>') : 'Aucune adresse e-mail pertinente trouvée';

      if (uniqTech.length) {
        html += `
          <details class="fr-mt-2w">
            <summary>Voir les résultats techniques (${uniqTech.length})</summary>
            <div class="fr-mt-1w fr-text--sm">
              ${uniqTech.join('<br>')}
            </div>
          </details>
        `;
      }
      blocks.push(html);
    }

    if (wantAgent) {
      blocks.push(`<strong>Appareil utilisé et application de l'expéditeur</strong><br>À brancher (comme avant)`);
    }

    output.innerHTML = blocks.join('<br><br>');
  });

  /* =========================
     LISTENER – REQUISITION
  ========================= */
  document.getElementById('btn-req-analyze')?.addEventListener('click', () => {
    const rawText = document.getElementById('inputReqText')?.value || '';
    const text = decodeQuotedPrintable(rawText);

    const wantMail   = document.getElementById('req-chk-mail')?.checked;
    const wantIP     = document.getElementById('req-chk-ip')?.checked;
    const wantPostal = document.getElementById('req-chk-postal')?.checked;
    const wantPhone  = document.getElementById('req-chk-phone')?.checked;

    const output = document.getElementById('req-results');
    if (!output) return;
    output.innerHTML = '';

    if (!wantMail && !wantIP && !wantPostal && !wantPhone) {
      output.textContent = 'Sélectionne au moins un type d’extraction.';
      return;
    }
    if (!text.trim()) {
      output.textContent = 'Colle un résultat de réquisition avant de lancer l’analyse.';
      return;
    }

    const blocks = [];

    if (wantMail) {
      const allMails = text.match(REGEX_MAIL) || [];
      const humanMails = allMails.filter(isHumanEmail);
      const uniqHuman = [...new Set(humanMails)].sort();

      let html = `<strong>Adresses e-mail (${uniqHuman.length})</strong><br><br>`;
      html += uniqHuman.length ? uniqHuman.join('<br>') : 'Aucune adresse e-mail trouvée';
      blocks.push(html);
    }

    if (wantIP) {
      const ips = extractIPsFromPlainText(text);
      const publicIPs = ips.filter(isPublicIP);
      const uniqPublic = [...new Set(publicIPs)].sort();

      let html = `<strong>Adresses IP (${uniqPublic.length})</strong><br><br>`;
      html += uniqPublic.length ? uniqPublic.map(ip => `• ${ip}`).join('<br>') : 'Aucune adresse IP publique trouvée';
      blocks.push(html);
    }

    if (wantPhone) {
      const phonesRaw = text.match(REGEX_PHONE) || [];
      const phones = phonesRaw.map(normalizePhoneFRDots).filter(Boolean);
      const uniq = [...new Set(phones)].sort();

      let html = `<strong>Téléphones (${uniq.length})</strong><br><br>`;
      html += uniq.length ? uniq.map(p => `• ${p}`).join('<br>') : 'Aucun numéro FR valide trouvé';
      blocks.push(html);
    }

    if (wantPostal) {
      const rows = extractPostalAddressesStructured(text);

      let html = `<strong>Adresses postales (${rows.length})</strong><br><br>`;
      if (!rows.length) {
        html += 'Aucune adresse postale probable trouvée';
      } else {
        html += `
          <div class="fr-table fr-table--layout-fixed fr-table--no-caption">
            <table>
              <thead>
                <tr>
                  <th scope="col">Adresse</th>
                  <th scope="col">Ville</th>
                  <th scope="col">Code postal</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r => `
                  <tr>
                    <td>${escapeHTML(r.adresse)}</td>
                    <td>${escapeHTML(r.ville)}</td>
                    <td>${escapeHTML(r.codePostal)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      blocks.push(html);
    }

    output.innerHTML = blocks.join('<br><br>');
  });
</script>

<!-- SCRIPT NAVIGATION -->
<script>
  const viewHome    = document.getElementById('view-home');
  const viewAnalyse = document.getElementById('view-analyse');
  const viewReq     = document.getElementById('view-req');

  const viewTuto    = document.getElementById('view-tuto');       // tuto entête
  const viewTutoReq = document.getElementById('view-tuto-req');   // tuto réquisition

  const btnShowTuto         = document.getElementById('btn-show-tuto');
  const btnBackAnalyse      = document.getElementById('btn-back-analyse');
  const btnBackHome         = document.getElementById('btn-back-home');

  const btnBackHomeFromReq  = document.getElementById('btn-back-home-from-req');
  const btnShowTutoFromReq  = document.getElementById('btn-show-tuto-from-req');
  const btnBackReq          = document.getElementById('btn-back-req');

  function showView(target) {
    viewHome.hidden = true;
    viewAnalyse.hidden = true;
    viewReq.hidden = true;
    viewTuto.hidden = true;
    viewTutoReq.hidden = true;

    target.hidden = false;
    window.scrollTo(0, 0);
  }

  // Cartes accueil
  document.addEventListener('click', (e) => {
    const goAnalyse = e.target.closest('#btn-go-analyse');
    if (goAnalyse) {
      e.preventDefault();
      showView(viewAnalyse);
      return;
    }

    const goReq = e.target.closest('#btn-go-req');
    if (goReq) {
      e.preventDefault();
      showView(viewReq);
      return;
    }
  });

  // Analyse entête → Tuto entête
  btnShowTuto?.addEventListener('click', () => showView(viewTuto));

  // Tuto entête → Analyse entête
  btnBackAnalyse?.addEventListener('click', () => showView(viewAnalyse));

  // Réquisition → Tuto réquisition
  btnShowTutoFromReq?.addEventListener('click', () => showView(viewTutoReq));

  // Tuto réquisition → Réquisition
  btnBackReq?.addEventListener('click', () => showView(viewReq));

  // Retours accueil
  btnBackHome?.addEventListener('click', () => showView(viewHome));
  btnBackHomeFromReq?.addEventListener('click', () => showView(viewHome));
</script>

<footer class="genesis-credit">
  GENESIS NG 2026 - MDC HUGO BRES--MALANCHERE - DEMO ADI 2026
</footer>

</body>
</html>
